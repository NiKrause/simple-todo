server {
    index index.html index.htm;
    server_name simple-todo.le-space.de;

    # Set the IPFS CID - update this when you deploy a new version
    set $ipfs_cid "QmWqNAxHK6g5aYW4v1ErkyH8sci4kVbHpCgQACVhPFyb9f";

    # Proxy static files directly to IPFS
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot|json|map|webp|avif|mp4|webm|ogg|mp3|wav|flac|aac|pdf|zip|tar|gz)$ {
        proxy_pass https://ipfs.le-space.de/ipfs/$ipfs_cid$request_uri;
        
        proxy_set_header X-Ipfs-Path /ipns/simple-todo.le-space.de;
        proxy_set_header Host simple-todo.le-space.de;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache off;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # All other requests (routes like /embed/..., /db/..., etc.) serve index.html
    # This allows SvelteKit's client-side router to handle the routing
    location / {
        proxy_pass https://ipfs.le-space.de/ipfs/$ipfs_cid/index.html;

        proxy_set_header X-Ipfs-Path /ipns/simple-todo.le-space.de;
        proxy_set_header Host simple-todo.le-space.de;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_cache off;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires 0;
    }

    listen 443 ssl;
    listen [::]:443;
    ssl_certificate /etc/letsencrypt/live/deamo.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/deamo.org/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

